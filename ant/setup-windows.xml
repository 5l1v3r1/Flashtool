<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<project default="all" name="Create Windows Package">
	
	<target name="all" depends="binaries, dodrivers, dosetup"/>

	<target name="main_lib" depends="loadprops">
        <jar destfile="../../Deploy/FlashTool/x10flasher.jar">
            <manifest>
                <attribute name="Main-Class" value="gui.Main"/>
                <attribute name="Implementation-Version" value="Version ${Internal-Version} built on ${Internal-Date}"/>
            	<attribute name="Internal-Version" value="${Internal-Version}"/>
            	<attribute name="Internal-Channel" value="${Internal-Channel}"/>
            </manifest>
        	<fileset dir="../bin" excludes="/gui/ressources/icons/**"/>
        </jar>
	</target>

	<target name="JRE">
		<unzip src="../jre/winjre.zip" dest="../../Deploy/FlashTool/x10flasher_native"/>
		<copy file="../jre/jce/local_policy.jar" todir="../../Deploy/FlashTool/x10flasher_native/winjre/lib/security"/>
		<copy file="../jre/jce/US_export_policy.jar" todir="../../Deploy/FlashTool/x10flasher_native/jre/lib/security"/>		
	</target>

	<target name="loadprops">
		<loadmf jar="../../Deploy/FlashTool/x10flasher_lib/x10flasher-res.jar" prefix=""/>
	</target>
	
	   <target name="dodrivers">
            <mkdir dir ="../../Deploy/FlashTool/drivers/"/>
	   	    <property environment="env"/>
	        <nsis script="../drivers.nsi" path="${env.ProgramFiles}\NSIS"/>
	    </target>
	 
	<target name="binaries" depends="main_lib, JRE">
		<copy file="../launchers/FlashTool64.exe" todir="../../Deploy/FlashTool"/>
    	<copy todir="../../Deploy/FlashTool/x10flasher_lib">
    		<fileset dir="../libs/win/x86_64/"/>
    	</copy>
    	<copy todir="../../Deploy/FlashTool/x10flasher_native">
    		<fileset dir="../native/win32/"/>
    	</copy>
	</target>

	<target name="dosetup" depends="loadprops">
		<property environment="env"/>
		<delete file="../../Deploy/FlashTool/config.properties"/>
		<delete file="../setup_new.nsi"/>
		<copy file="../setup.nsi" tofile="../setup_new.nsi"/>
		<replace file="../setup_new.nsi" token="FLASHTOOLVERSION" value="${Internal-Version}"/>
		<nsis script="../setup_new.nsi" path="${env.ProgramFiles}\NSIS"/>
		<delete file="../setup_new.nsi"/>
	</target>

	<!--
	    Loads entries from a manifest file.
	    @jar     The jar from where to read
	    @prefix  A prefix to prepend
	-->
	    <macrodef name="loadmf">
	        <attribute name="jar"/>
	        <attribute name="prefix" default=""/>
	        <sequential>
	            <loadproperties>
	                <!-- Load the manifest entries -->
	                <zipentry zipfile="@{jar}" name="META-INF/MANIFEST.MF"/>
	                <!-- Add the prefix -->
	                <filterchain>
	                    <prefixlines prefix="@{prefix}"/>
	                </filterchain>
	            </loadproperties>
	        </sequential>
	    </macrodef>
    
	<taskdef name="nsis" classname="com.danielreese.nsisant.Task">
       <classpath location="../libs/nsis/nsisant-1.3.jar"/>
     </taskdef>

</project>